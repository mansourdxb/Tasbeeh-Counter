import React, { useMemo, useState } from "react";
import {
  View,
  Text,
  StyleSheet,
  Pressable,
  ScrollView,
  useWindowDimensions,
  Platform,
} from "react-native";
import { LinearGradient } from "expo-linear-gradient";
import { useSafeAreaInsets } from "react-native-safe-area-context";
import { useBottomTabBarHeight } from "@react-navigation/bottom-tabs";
import { useNavigation } from "@react-navigation/native";
import type { NativeStackNavigationProp } from "@react-navigation/native-stack";
import type { LibraryStackParamList } from "@/navigation/LibraryStackNavigator";
import { useTheme } from "@/context/ThemeContext";

import riyad from "@/constants/library/Riyad_Salheen.json";
import bulugh from "@/constants/library/bulugh_almaram.json";
import adab from "@/constants/library/aladab_almufrad.json";
import qudsi from "@/constants/library/qudsi40.json";

type LibraryTabKey = "quran" | "hadith";

function SegmentedTabs({
  value,
  onChange,
  width,
  colors,
  items,
}: {
  value: LibraryTabKey;
  onChange: (k: LibraryTabKey) => void;
  width: number;
  colors: {
    wrapBg: string;
    activeBg: string;
    text: string;
    textActive: string;
  };
  items: { key: LibraryTabKey; label: string }[];
}) {
  return (
    <View style={[styles.segmentWrap, { width, backgroundColor: colors.wrapBg }]}>
      {items.map((it) => {
        const active = it.key === value;
        return (
          <Pressable
            key={it.key}
            onPress={() => onChange(it.key)}
            style={({ pressed }) => [
              styles.segmentBtn,
              active ? { backgroundColor: colors.activeBg } : null,
              pressed ? { opacity: 0.92 } : null,
            ]}
          >
            <Text
              style={[
                styles.segmentText,
                { color: colors.text },
                active ? { color: colors.textActive } : null,
              ]}
            >
              {it.label}
            </Text>
          </Pressable>
        );
      })}
    </View>
  );
}

function Card({
  children,
  outerStyle,
  innerStyle,
}: {
  children: React.ReactNode;
  outerStyle?: any;
  innerStyle?: any;
}) {
  return (
    <View style={[styles.cardOuter, outerStyle]}>
      <View style={[styles.cardInner, innerStyle]}>{children}</View>
    </View>
  );
}

function getCount(data: any) {
  if (Array.isArray(data)) return data.length;
  if (!data || typeof data !== "object") return 0;
  if (Array.isArray((data as any).items)) return (data as any).items.length;
  if (Array.isArray((data as any).hadiths)) return (data as any).hadiths.length;
  if (Array.isArray((data as any).ahadith)) return (data as any).ahadith.length;
  if (Array.isArray((data as any).chapters)) return (data as any).chapters.length;
  return Object.keys(data).length;
}

export default function LibraryScreen() {
  const insets = useSafeAreaInsets();
  const tabBarHeight = useBottomTabBarHeight();
  const { width } = useWindowDimensions();
  const { colors, isDarkMode } = useTheme();
  const navigation = useNavigation<NativeStackNavigationProp<LibraryStackParamList>>();

  const maxW = 430;
  const contentWidth = Math.min(width, maxW);

  const books = useMemo(
    () => [
      { key: "riyad" as const, label: "\u0631\u064a\u0627\u0636 \u0627\u0644\u0635\u0627\u0644\u062d\u064a\u0646", data: riyad },
      { key: "bulugh" as const, label: "\u0628\u0644\u0648\u063a \u0627\u0644\u0645\u0631\u0627\u0645", data: bulugh },
      { key: "adab" as const, label: "\u0627\u0644\u0623\u062f\u0628 \u0627\u0644\u0645\u0641\u0631\u062f", data: adab },
      { key: "qudsi" as const, label: "\u0627\u0644\u0623\u062d\u0627\u062f\u064a\u062b \u0627\u0644\u0642\u062f\u0633\u064a\u0629", data: qudsi },
    ],
    []
  );

  const [active, setActive] = useState<LibraryTabKey>("quran");

  const headerGradientColors = colors.headerGradient as [string, string, ...string[]];
  const pageBackground = colors.background;
  const sheetBackground = isDarkMode ? "#0D0F12" : "#F3F5F8";
  const cardOuterBackground = isDarkMode ? "#000000" : "#E7EDF4";
  const cardInnerBackground = isDarkMode ? "#2F2F30" : "#FFFFFF";
  const primaryText = isDarkMode ? "#FFFFFF" : "#111418";
  const secondaryText = isDarkMode ? "rgba(255,255,255,0.65)" : "rgba(17,20,24,0.55)";
  const segmentColors = {
    wrapBg: isDarkMode ? "rgba(255,255,255,0.08)" : "rgba(0,0,0,0.10)",
    activeBg: isDarkMode ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.18)",
    text: isDarkMode ? "rgba(255,255,255,0.75)" : "rgba(255,255,255,0.85)",
    textActive: "#FFFFFF",
  };

  return (
    <View style={[styles.root, { backgroundColor: pageBackground }]}>
      <LinearGradient
        colors={headerGradientColors}
        style={[styles.header, { paddingTop: insets.top + 12 }]}
      >
        <View style={[styles.headerInner, { width: contentWidth }]}>
          <Text style={styles.headerTitle}>
            {"\u0627\u0644\u0645\u0643\u062a\u0628\u0629"}
          </Text>
          <SegmentedTabs
            value={active}
            onChange={setActive}
            width={contentWidth - 28}
            colors={segmentColors}
            items={[
              { key: "quran", label: "\u0627\u0644\u0642\u0631\u0627\u0646" },
              { key: "hadith", label: "\u0627\u0644\u062d\u062f\u064a\u062b" },
            ]}
          />
        </View>
      </LinearGradient>

      <ScrollView
        style={{ width: contentWidth }}
        contentContainerStyle={{ paddingBottom: tabBarHeight + 24 }}
        showsVerticalScrollIndicator={false}
      >
        <View style={[styles.sheet, { backgroundColor: sheetBackground }]}>
          {active === "quran" ? (
            <Card
              outerStyle={{ backgroundColor: cardOuterBackground }}
              innerStyle={{ backgroundColor: cardInnerBackground }}
            >
              <Text style={[styles.cardTitle, { color: primaryText }]}>
                {"\u0627\u0644\u0642\u0631\u0622\u0646 \u0627\u0644\u0643\u0631\u064a\u0645"}
              </Text>
              <Text style={[styles.cardSub, { color: secondaryText }]}>
                {"\u0645\u062d\u062a\u0648\u0649 \u0627\u0644\u0642\u0631\u0622\u0646 \u0633\u064a\u062a\u0645 \u0625\u0636\u0627\u0641\u062a\u0647 \u0647\u0646\u0627."}
              </Text>
            </Card>
          ) : null}

          {active === "hadith" ? (
            <>
              <View style={styles.hadithList}>
                {[
                  {
                    id: "bukhari",
                    title_ar: "\u0635\u062d\u064a\u062d \u0627\u0644\u0628\u062e\u0627\u0631\u064a",
                    subtitle_ar:
                      "\u0645\u062d\u0645\u062f \u0628\u0646 \u0625\u0633\u0645\u0627\u0639\u064a\u0644 \u0627\u0644\u0628\u062e\u0627\u0631\u064a",
                  },
                  {
                    id: "muslim",
                    title_ar: "\u0635\u062d\u064a\u062d \u0645\u0633\u0644\u0645",
                    subtitle_ar:
                      "\u0645\u0633\u0644\u0645 \u0628\u0646 \u0627\u0644\u062d\u062c\u0627\u062c \u0627\u0644\u0646\u064a\u0633\u0627\u0628\u0648\u0631\u064a",
                  },
                  {
                    id: "abudawud",
                    title_ar: "\u0633\u0646\u0646 \u0623\u0628\u064a \u062f\u0627\u0648\u062f",
                    subtitle_ar: "\u0623\u0628\u0648 \u062f\u0627\u0648\u062f \u0627\u0644\u0633\u062c\u0633\u062a\u0627\u0646\u064a",
                  },
                  {
                    id: "tirmidhi",
                    title_ar: "\u062c\u0627\u0645\u0639 \u0627\u0644\u062a\u0631\u0645\u0630\u064a",
                    subtitle_ar: "\u0623\u0628\u0648 \u0639\u064a\u0633\u0649 \u0627\u0644\u062a\u0631\u0645\u0630\u064a",
                  },
                  {
                    id: "nasai",
                    title_ar: "\u0633\u0646\u0646 \u0627\u0644\u0646\u0633\u0627\u0626\u064a",
                    subtitle_ar: "\u0623\u062d\u0645\u062f \u0628\u0646 \u0634\u0639\u064a\u0628 \u0627\u0644\u0646\u0633\u0627\u0626\u064a",
                  },
                  {
                    id: "ibnmajah",
                    title_ar: "\u0633\u0646\u0646 \u0627\u0628\u0646 \u0645\u0627\u062c\u0647",
                    subtitle_ar: "\u0645\u062d\u0645\u062f \u0628\u0646 \u064a\u0632\u064a\u062f \u0628\u0646 \u0645\u0627\u062c\u0647",
                  },
                  {
                    id: "malik",
                    title_ar: "\u0645\u0648\u0637\u0623 \u0627\u0644\u0625\u0645\u0627\u0645 \u0645\u0627\u0644\u0643",
                    subtitle_ar: "\u0645\u0627\u0644\u0643 \u0628\u0646 \u0623\u0646\u0633",
                  },
                  {
                    id: "ahmad",
                    title_ar:
                      "\u0645\u0633\u0646\u062f \u0627\u0644\u0625\u0645\u0627\u0645 \u0623\u062d\u0645\u062f \u0628\u0646 \u062d\u0646\u0628\u0644",
                    subtitle_ar: "\u0623\u062d\u0645\u062f \u0628\u0646 \u062d\u0646\u0628\u0644",
                  },
                  {
                    id: "darimi",
                    title_ar: "\u0633\u0646\u0646 \u0627\u0644\u062f\u0627\u0631\u0645\u064a",
                    subtitle_ar:
                      "\u0639\u0628\u062f \u0627\u0644\u0644\u0647 \u0628\u0646 \u0639\u0628\u062f \u0627\u0644\u0631\u062d\u0645\u0646 \u0627\u0644\u062f\u0627\u0631\u0645\u064a",
                  },
                ].map((item, idx) => (
                  <Pressable
                    key={`hadith-book-${item.id}-${idx}`}
                    onPress={() => {
                      if (item.id === "bukhari") {
                        navigation.navigate("BukhariBooks");
                      } else if (item.id === "muslim") {
                        navigation.navigate("MuslimBooks");
                      } else if (item.id === "abudawud") {
                        navigation.navigate("AbuDawudBooks");
                      } else if (item.id === "ahmad") {
                        navigation.navigate("AhmedBooks");
                      } else if (item.id === "darimi") {
                        navigation.navigate("DarimiBooks");
                      }
                    }}
                    style={[styles.hadithCardOuter, { backgroundColor: cardOuterBackground }]}
                  >
                    <View
                      style={[styles.hadithCardInner, { backgroundColor: cardInnerBackground }]}
                    >
                      <Text style={[styles.hadithCardTitle, { color: primaryText }]}>
                        {item.title_ar}
                      </Text>
                      <Text style={[styles.hadithCardSub, { color: secondaryText }]}>
                        {item.subtitle_ar}
                      </Text>
                    </View>
                  </Pressable>
                ))}
              </View>

              <Card
                outerStyle={{ backgroundColor: cardOuterBackground, marginTop: 12 }}
                innerStyle={{ backgroundColor: cardInnerBackground }}
              >
                <Text style={[styles.cardTitle, { color: primaryText }]}>
                  {"\u0643\u062a\u0628 \u0627\u0644\u062d\u062f\u064a\u062b \u0627\u0644\u0645\u062d\u0644\u064a\u0629"}
                </Text>
                <Text style={[styles.cardSub, { color: secondaryText }]}>
                  {"\u0631\u064a\u0627\u0636 \u0627\u0644\u0635\u0627\u0644\u062d\u064a\u0646\u060c \u0628\u0644\u0648\u063a \u0627\u0644\u0645\u0631\u0627\u0645\u060c \u0627\u0644\u0623\u062f\u0628 \u0627\u0644\u0645\u0641\u0631\u062f\u060c \u0627\u0644\u0623\u062d\u0627\u062f\u064a\u062b \u0627\u0644\u0642\u062f\u0633\u064a\u0629"}
                </Text>
                <View style={styles.statRow}>
                  <Text style={[styles.statValue, { color: primaryText }]}>
                    {books.reduce((acc, b) => acc + getCount(b.data), 0)}
                  </Text>
                  <Text style={[styles.statLabel, { color: secondaryText }]}>
                    {"\u0625\u062c\u0645\u0627\u0644\u064a \u0627\u0644\u0639\u0646\u0627\u0635\u0631"}
                  </Text>
                </View>
              </Card>
            </>
          ) : null}
        </View>
      </ScrollView>
    </View>
  );
}

const styles = StyleSheet.create({
  root: {
    flex: 1,
    alignItems: "center",
  },
  header: {
    width: "100%",
    paddingBottom: 16,
    alignItems: "center",
  },
  headerInner: {
    paddingHorizontal: 14,
    alignItems: "center",
  },
  headerTitle: {
    color: "#FFFFFF",
    fontSize: 40,
    fontWeight: "900",
    textAlign: "center",
    marginBottom: 10,
  },
  segmentWrap: {
    flexDirection: "row-reverse",
    borderRadius: 18,
    padding: 4,
    alignSelf: "center",
  },
  segmentBtn: {
    flex: 1,
    paddingVertical: 10,
    borderRadius: 14,
    alignItems: "center",
    justifyContent: "center",
  },
  segmentText: {
    fontSize: 14,
    fontWeight: "800",
    textAlign: "center",
  },
  sheet: {
    flex: 1,
    borderTopLeftRadius: 26,
    borderTopRightRadius: 26,
    paddingTop: 16,
    paddingHorizontal: 14,
  },
  cardOuter: {
    borderRadius: 28,
    padding: 10,
    ...(Platform.OS === "web" ? ({ boxShadow: "0 12px 30px rgba(0,0,0,0.12)" } as any) : null),
  },
  cardInner: {
    borderRadius: 22,
    padding: 16,
  },
  cardTitle: {
    fontSize: 22,
    fontWeight: "900",
    textAlign: "right",
  },
  cardSub: {
    marginTop: 6,
    fontSize: 14,
    fontWeight: "700",
    textAlign: "right",
  },
  statRow: {
    marginTop: 16,
    alignItems: "flex-end",
  },
  statValue: {
    fontSize: 28,
    fontWeight: "900",
  },
  statLabel: {
    marginTop: 4,
    fontSize: 13,
    fontWeight: "700",
  },
  hadithList: {
    gap: 12,
  },
  hadithCardOuter: {
    borderRadius: 22,
    padding: 8,
    ...(Platform.OS === "web"
      ? ({ boxShadow: "0 10px 24px rgba(0,0,0,0.10)" } as any)
      : null),
  },
  hadithCardInner: {
    borderRadius: 18,
    paddingVertical: 16,
    paddingHorizontal: 14,
  },
  hadithCardTitle: {
    fontSize: 18,
    fontWeight: "900",
    textAlign: "right",
  },
  hadithCardSub: {
    marginTop: 4,
    fontSize: 13,
    fontWeight: "700",
    textAlign: "right",
  },
  grid: {
    flexDirection: "row",
    flexWrap: "wrap",
    gap: 12,
  },
  gridCardOuter: {
    width: "48%",
    borderRadius: 22,
    padding: 8,
    ...(Platform.OS === "web" ? ({ boxShadow: "0 10px 24px rgba(0,0,0,0.10)" } as any) : null),
  },
  gridCardInner: {
    borderRadius: 18,
    paddingVertical: 18,
    paddingHorizontal: 10,
    alignItems: "center",
    justifyContent: "center",
  },
  gridIcon: {
    fontSize: 24,
    marginBottom: 8,
  },
  gridText: {
    fontSize: 16,
    fontWeight: "900",
    textAlign: "center",
  },
});
